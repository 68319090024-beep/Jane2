/*************************************************
 * ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô (Soil)
 *************************************************/
#include <ESP8266WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <ArduinoJson.h>
#include <FirebaseESP8266.h>
#include <ESP8266WebServer.h>
#include "DHT.h"

/* ===== WiFi & Cloud Config ===== */
const char* ssid = "Jane";
const char* password = "0821926943";
#define BOT_TOKEN "8554659037:AAEx9DWoUNk1FlG6m_aZvat7dKlMWiOfkOQ"
#define CHAT_ID "-1003695024067"
#define FIREBASE_HOST "kun16-95305-default-rtdb.firebaseio.com"
#define FIREBASE_AUTH "JzYsdDN0mMtzTIzbxcPKzc98pbmf0yK2bg57HxoF"

/* ===== Hardware Pins ===== */
#define VIB_PIN D2
#define SOIL_PIN A0  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å SND_PIN ‡πÄ‡∏õ‡πá‡∏ô SOIL_PIN (‡πÉ‡∏ä‡πâ‡∏Ç‡∏≤ Analog ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
#define DHT_PIN D6
#define BZ_PIN  D7
#define DHTTYPE DHT11

/* ===== Settings ===== */
// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
const int SOIL_ALERT_THRESHOLD = 30; // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 30% ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á)

/* ===== Objects ===== */
DHT dht(DHT_PIN, DHTTYPE);
ESP8266WebServer server(80);
FirebaseData firebaseData;
FirebaseConfig config;
FirebaseAuth auth;
WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

/* ===== Control Variables ===== */
bool alertLocked = false;
unsigned long lastTempUpdate = 0; 
const int updateInterval = 2000; 

void setup() {
  Serial.begin(9600);

  pinMode(VIB_PIN, INPUT);
  // pinMode(SOIL_PIN, INPUT); // A0 ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® pinMode ‡πÉ‡∏ô ESP8266 ‡∏Å‡πá‡πÑ‡∏î‡πâ
  pinMode(BZ_PIN, OUTPUT);
  digitalWrite(BZ_PIN, HIGH); // ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå

  dht.begin();

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi Connected");
  Serial.println(WiFi.localIP());

  // ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram =====
  client.setInsecure();
  client.setTimeout(15000);
  client.setBufferSizes(1024, 1024);

  // ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase =====
  config.host = FIREBASE_HOST;
  config.signer.tokens.legacy_token = FIREBASE_AUTH;
  Firebase.begin(&config, &auth);
}

void loop() {
  // ========================================================
  // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå
  // ========================================================
  int v = digitalRead(VIB_PIN); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡πà‡∏ô (Digital)
  
  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (Analog)
  int soilRaw = analogRead(SOIL_PIN); 
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ Analog (0-1024) ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (0-100%)
  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà 1024=‡πÅ‡∏´‡πâ‡∏á‡∏™‡∏ô‡∏¥‡∏ó, 0=‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥ (‡∏ï‡πâ‡∏≠‡∏á map ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô)
  int soilPercent = map(soilRaw, 1024, 0, 0, 100); 
  
  // ‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
  if(soilPercent < 0) soilPercent = 0;
  if(soilPercent > 100) soilPercent = 100;

  float t = dht.readTemperature(); 
  if (isnan(t)) t = 0.0;

  // ========================================================
  // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Firebase (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏´‡∏°)
  // ========================================================
  bool webAlert = false;
  bool webVibStatus = false;
  bool webSoilStatus = false; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Soil

  if (Firebase.getBool(firebaseData, "/Monitor/alert")) {
    webAlert = firebaseData.boolData();
  }
  if (Firebase.getBool(firebaseData, "/Monitor/vibrate")) {
    webVibStatus = firebaseData.boolData();
  }
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Key ‡πÉ‡∏ô Firebase ‡πÄ‡∏õ‡πá‡∏ô soil_alert
  if (Firebase.getBool(firebaseData, "/Monitor/soil_alert")) {
    webSoilStatus = firebaseData.boolData();
  }

  // ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô False ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset)
  if (webAlert == false && webVibStatus == false && webSoilStatus == false) {
      digitalWrite(BZ_PIN, HIGH); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
      
      if (alertLocked == true) {
          alertLocked = false; 
          Serial.println("System Reset: Ready to monitor again.");
      }
  }

  // ========================================================
  // 3. ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ 
  // ========================================================
  if (!alertLocked) {
    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏™‡∏±‡πà‡∏ô (HIGH) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á)
    if (v == HIGH || soilPercent < SOIL_ALERT_THRESHOLD) { 
      
      alertLocked = true;         
      digitalWrite(BZ_PIN, LOW);  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå
      Serial.println("ALARM TRIGGERED!");

      // --- ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô Firebase ---
      Firebase.setBool(firebaseData, "/Monitor/alert", true);
      // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      Firebase.setBool(firebaseData, "/Monitor/soil_alert", (soilPercent < SOIL_ALERT_THRESHOLD)); 
      Firebase.setBool(firebaseData, "/Monitor/vibrate", (v == HIGH));
      Firebase.setFloat(firebaseData, "/Monitor/temp", t);
      Firebase.setInt(firebaseData, "/Monitor/soil_value", soilPercent); // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢

      // --- ‡∏™‡πà‡∏á Telegram ---
      String msg = "‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢!\n";
      msg += "üå° ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: " + String(t, 2) + " ¬∞C\n";
      
      if (v == HIGH) {
        msg += "‚ö° ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô:  ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô!\n";
      } else {
        msg += "‚ö° ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô: ‡∏õ‡∏Å‡∏ï‡∏¥\n";
      }

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
      msg += "üå± ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: " + String(soilPercent) + "%";
      if (soilPercent < SOIL_ALERT_THRESHOLD) {
        msg += " (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå!)\n";
      } else {
        msg += " (‡∏õ‡∏Å‡∏ï‡∏¥)\n";
      }
      
      if (WiFi.status() == WL_CONNECTED) {
        bot.sendMessage(CHAT_ID, msg, "");
        Serial.println("Telegram Sent!");
      }
    }
  }

  // ========================================================
  // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Firebase ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ (Real-time)
  // ========================================================
  if (millis() - lastTempUpdate > updateInterval) {
    lastTempUpdate = millis();
    Firebase.setFloat(firebaseData, "/Monitor/temp", t);
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    Firebase.setInt(firebaseData, "/Monitor/soil_value", soilPercent);
  }

  delay(100); 
}
